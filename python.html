<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Python</title>

<script src="site_libs/header-attrs-2.5/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>




<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Stata</a>
</li>
<li>
  <a href="utils.html">Astuces &amp; utilitaires</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Graphiques
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="graphiques.html">Formation 2020</a>
    </li>
    <li>
      <a href="ridge.html">Ridge</a>
    </li>
    <li>
      <a href="lollipop.html">Lollipop</a>
    </li>
    <li>
      <a href="spaghetti.html">Effet spaghetti</a>
    </li>
    <li>
      <a href="parallel.html">Parallel</a>
    </li>
    <li>
      <a href="forest_plot.html">Forest Plot</a>
    </li>
  </ul>
</li>
<li>
  <a href="python.html">Python</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Python</h1>

</div>


<p><strong>MAJ du 12 février 2021</strong>: début d’une section sur la visualisation des données avec Python, avec des codes exécutables dans un .do.<br />
<br></p>
<ul>
<li>Depuis la version 16 de Stata (printemps 2019) il est possible d’utiliser Python de manière intéractive avec Stata.</li>
<li>Une librairie Python <code>SFI</code> (<a href="https://www.stata.com/python/api16/Data.html" class="uri">https://www.stata.com/python/api16/Data.html</a>) est mise à disposition pour favoriser cette interactivé.</li>
<li>A l’inverse, une librairie Python officielle devrait être mis à disposition pour utiliser Stata sous <strong>Jupyter</strong> et <strong>Spyder</strong>. Actuellement, un noyau Stata [<strong>Statakernel</strong>] est déjà disponible pour <strong>Jupyter</strong> et <strong>Atom</strong> et fonctionne très bien.</li>
<li>En l’état, il me semble que Python peut permettre à Stata de s’étoffer sur deux domaines: le <em>machine learning</em> (<code>sklearn</code>) et les graphiques <em>data visualization</em>: <code>matplotlib</code>/<code>seaborn</code>, le wrapper de ggplot2 <code>plotnine</code> et, pour les graphiques intéractifs et dynamique <code>plotly</code>).</li>
<li>l’entrée de l’aide Stata pour utiliser Python: <code>help python</code></li>
<li>Eléments de Correspondance Stata - Python pour la manipulation des données (librairie<code>pandas</code>): <a href="https://pandas.pydata.org/docs/getting_started/comparison/comparison_with_stata.html#compare-with-stata" class="uri">https://pandas.pydata.org/docs/getting_started/comparison/comparison_with_stata.html#compare-with-stata</a></li>
</ul>
<div id="installation-de-python-et-des-librairies-windows" class="section level1" number="1">
<h1 number="1"><span class="header-section-number">1</span> Installation de Python et des librairies (Windows)</h1>
<div id="intallation-de-python" class="section level2" number="1.1">
<h2 number="1.1"><span class="header-section-number">1.1</span> Intallation de Python</h2>
<p><strong>WARNING</strong> Pour utiliser Python, vous devez avoir le même type de built pour les deux applications:</p>
<ul>
<li>Stata 64 bits =&gt; Python 64 Bits</li>
<li>Stata 32 bits =&gt; Pyhon 32 bits</li>
</ul>
<p><em>Python 64</em></p>
<ul>
<li>Installation Standard: <a href="https://www.python.org/downloads/windows/" class="uri">https://www.python.org/downloads/windows/</a></li>
<li>Anaconda: <a href="https://www.anaconda.com/products/individual" class="uri">https://www.anaconda.com/products/individual</a> / Miniconda: <a href="https://docs.conda.io/en/latest/miniconda.html" class="uri">https://docs.conda.io/en/latest/miniconda.html</a></li>
</ul>
<p><em>Python 32</em></p>
<ul>
<li>Installation Standard: <a href="https://www.python.org/downloads/" class="uri">https://www.python.org/downloads/</a></li>
<li>Anaconda: <a href="https://www.anaconda.com/products/individual" class="uri">https://www.anaconda.com/products/individual</a> / Miniconda: <a href="https://docs.conda.io/en/latest/miniconda.htm" class="uri">https://docs.conda.io/en/latest/miniconda.htm</a></li>
</ul>
<p>Pour un usage minimal de Python, il n’est pas recommander d’installer <em>Anaconda</em> qui prend beaucoup d’espace. <em>Miniconda</em> devrait suffire.</p>
<p><br> <strong>Installation standard et première utilisation</strong></p>
<ul>
<li><a href="https://www.python.org/downloads/windows/" class="uri">https://www.python.org/downloads/windows/</a></li>
<li>Bien vérifier que la case <strong>[ADD python 3.8 to PATH]</strong> est bien cochée</li>
<li>Ne pas modifier le répertoire d’installation normalement, sous windows: <code>C:\Users\username\AppData\Local\Programs\Python</code></li>
<li>Une fois l’installation terminée, ouvrir l’invite de commande [taper <code>cmd</code> dans la boite de recherche du menu windows, ou sous Stata exécuter <code>!</code> ou <code>shell</code>]</li>
<li>Dans le prompteur, exécuter <code>python</code> puis effectuer une operation simple <code>1+1</code> ou <code>print("Bonjour python")</code></li>
</ul>
</div>
<div id="installation-des-librairies-python" class="section level2" number="1.2">
<h2 number="1.2"><span class="header-section-number">1.2</span> Installation des librairies Python</h2>
<ul>
<li>Peu de librairies sont installées lors de l’installation</li>
<li>On peut obtenir leur liste avec la commande <code>help("modules")</code></li>
<li>Pour vérifier la présence d’une librairie: <code>help("nom_librairie")</code></li>
</ul>
<pre><code>help(&quot;statsmodels&quot;)
No Python documentation found for &#39;statsmodels&#39;.
Use help() to get the interactive help utility.
Use help(str) for help on the str class.</code></pre>
<ul>
<li>Pour installer une librairie, on utilise la commande <code>pip</code> normalement installée avec Python (vérifier avec <code>help("pip")</code>)</li>
<li>Exemple: Installation de <code>statmodels</code>:
<ul>
<li>[1] Réouvrir le prompteur windows</li>
<li>[2] Exécuter <code>pip install statsmodels</code> (ou <code>! pip install statsmodels</code> sous Stata)</li>
</ul></li>
</ul>
<pre><code>help(&quot;statsmodels&quot;)
NAME
    statsmodels

PACKAGE CONTENTS
    _version
    api
    base (package)
    compat (package)
    conftest
    datasets (package)
    discrete (package)
    distributions (package)
    duration (package)
    emplike (package)
    formula (package)
    gam (package)
    genmod (package)
    graphics (package)
    imputation (package)
    interface (package)
    iolib (package)
    miscmodels (package)
    multivariate (package)
    nonparametric (package)
    regression (package)
    resampling (package)
    robust (package)
    sandbox (package)
    src (package)
    stats (package)
    tests (package)
    tools (package)
    tsa (package</code></pre>
<ul>
<li>Comme pour <em>R</em>, l’installation d’une librairie installe également les dépendances. Par exemple la librairie <code>pandas</code> installera <code>numpy</code>.</li>
</ul>
<p>Extrait de l’aide <code>numpy</code> après l’installation de <code>pandas</code></p>
<pre><code>help(&quot;numpy&quot;)
NAME
    numpy

DESCRIPTION
    NumPy
    =====

    Provides
      1. An array object of arbitrary homogeneous items
      2. Fast mathematical operations over arrays
      3. Linear Algebra, Fourier Transforms, Random Number Generation

    How to use the documentation
    ----------------------------
    Documentation is available in two forms: docstrings provided
    with the code, and a loose standing reference guide, available from
    `the NumPy homepage &lt;https://www.scipy.org&gt;`_.

    We recommend exploring the docstrings using
    `IPython &lt;https://ipython.org&gt;`_, an advanced Python shell with
    TAB-completion and introspection capabilities.  See below for further
    instructions.

    The docstring examples assume that `numpy` has been imported as `np`::

      &gt;&gt;&gt; import numpy as np
      
(...)      
      </code></pre>
<p><strong>Mise à jour d’une librairie</strong>: <code>pip install nom_librairie --upgrade</code></p>
</div>
<div id="librairies-graphiques" class="section level2" number="1.3">
<h2 number="1.3"><span class="header-section-number">1.3</span> Librairies graphiques</h2>
<p>Une liste des principales libraires graphiques de Python:</p>
<ul>
<li><strong>matplotlib</strong>: <code>pip install matplotlib</code> [<a href="https://matplotlib.org/" class="uri">https://matplotlib.org/</a>]</li>
<li><strong>seaborn</strong>: <code>pip install seaborn</code> [<a href="https://seaborn.pydata.org/" class="uri">https://seaborn.pydata.org/</a>]</li>
<li><strong>plotly</strong>: <code>pip install plotly</code> [<a href="https://plotly.com/python/" class="uri">https://plotly.com/python/</a>]</li>
</ul>
<p>Attention: certaines librairies graphiques comme <strong>Altair</strong> ou <strong>Bokeh</strong> ne sont utilisables que sous certains environnement comme <em>Jupyter</em>, et ne pourront donc pas être utilisées dans un <em>.do</em> de Stata.</p>
</div>
</div>
<div id="exécuter-python-avec-stata" class="section level1" number="2">
<h1 number="2"><span class="header-section-number">2</span> Exécuter Python avec Stata</h1>
<p>Aide Stata: <code>help python</code></p>
<div id="lecture-de-python-par-stata" class="section level2" number="2.1">
<h2 number="2.1"><span class="header-section-number">2.1</span> Lecture de Python par Stata</h2>
<p><strong>Rappel</strong>: s’assurer de la concordance des builts (Stata 64 =&gt; Python 64 / Stata 32 =&gt; Python 32)</p>
<ul>
<li>Lorsque Python est installé, on peut vérifier qu’il est bien reconnu avec <code>python query</code></li>
</ul>
<pre><code>python query

    Python Settings
      set python_exec      C:\Users\thevenin_m\AppData\Local\Continuum\anaconda3\python.exe
      set python_userpath  

    Python system information
      initialized          no
      version              3.7.3
      architecture         64-bit
      library path         C:\Users\thevenin_m\AppData\Local\Continuum\anaconda3\python37.dll

</code></pre>
<ul>
<li>Si on a plusieurs installations de Python (Standard et Conda par exemples), on peut récupérer les chemins d’accès avec <code>python search</code>:</li>
</ul>
<pre><code>python search 
 Python environments found:  
 C:\Users\thevenin_m\AppData\Local\Continuum\anaconda3\python.exe
 C:\Users\thevenin_m\AppData\Local\Programs\Python\Python38\python.exe
</code></pre>
<ul>
<li>On peut changer de version de python avec <code>python set exec path [,permanently]</code></li>
</ul>
<pre><code>python set exec C:\Users\thevenin_m\AppData\Local\Programs\Python\Python38\python.exe
python query

    Python Settings
      set python_exec      C:\Users\thevenin_m\AppData\Local\Programs\Python\Python38\python.exe
      set python_userpath  

    Python system information
      initialized          no
      version              3.8.3
      architecture         64-bit
      library path         C:\Users\thevenin_m\AppData\Local\Programs\Python\Python38\python38.dll
</code></pre>
</div>
<div id="utilisation-de-python-en-mode-interactif" class="section level2" number="2.2">
<h2 number="2.2"><span class="header-section-number">2.2</span> Utilisation de python en mode interactif</h2>
<ul>
<li>Une ligne</li>
</ul>
<pre><code>python: print(&quot;Bonjour Python&quot;)

Bonjour Python</code></pre>
<ul>
<li>Un bloc de ligne</li>
</ul>
<pre><code>python:
a=2
b=10
a*b
end


&gt;&gt;&gt; a=2
&gt;&gt;&gt; b=10
&gt;&gt;&gt; a*b
20
&gt;&gt;&gt; end
</code></pre>
<ul>
<li><code>python describe</code>: permet d’afficher les objets python en mémoire</li>
</ul>
<pre><code>python describe namelist
a: 
2

b: 
10</code></pre>
<ul>
<li><code>Python drop</code> permet d’effacer des objets python en mémoire</li>
</ul>
<pre><code>python drop a
python describe namelist
b: 
10
</code></pre>
<ul>
<li><code>Python clear</code> permet d’effacer tous les objets python en mémoire</li>
</ul>
<pre><code>python clear
python describe
</code></pre>
</div>
<div id="quelques-exemples-dutilisation-de-python-graphiques" class="section level2" number="2.3">
<h2 number="2.3"><span class="header-section-number">2.3</span> Quelques exemples d’utilisation de Python (graphiques)</h2>
<div id="chargement-dune-base-stata-avec-python" class="section level3" number="2.3.1">
<h3 number="2.3.1"><span class="header-section-number">2.3.1</span> Chargement d’une base Stata avec Python</h3>
<ul>
<li>Une librarie est chargée avec l’instruction <code>import</code>. Un acronyme lui est associé, ici <code>pa</code> (en anglais c’est généralement <code>pd</code>….on s’en passera)</li>
<li><code>pandas</code> a une fonction permettant de lire une base en format .dta [<code>read_dta()</code>]</li>
<li>la fonction <code>nom_base.head(#)</code> permet d’afficher les premières lignes de la base</li>
</ul>
<pre><code>sysuse auto, clear
keep price mpg displacement gear_ratio turn foreign
save auto, replace

python:
import pandas as pa 
df = pa.read_stata(&#39;auto.dta&#39;)
df.head()
end

&gt;&gt;&gt; df.head()
   price  mpg  turn  displacement  gear_ratio   foreign
0   4099   22    40           121        3.58  Domestic
1   4749   17    40           258        2.53  Domestic
2   3799   22    35           121        3.08  Domestic
3   4816   20    40           196        2.93  Domestic
4   7827   15    43           350        2.41  Domestic
</code></pre>
</div>
<div id="exemple-1" class="section level3" number="2.3.2">
<h3 number="2.3.2"><span class="header-section-number">2.3.2</span> Exemple 1</h3>
<ul>
<li>Création d’un graphique de type matrixplot avec la librairie <code>seaborn</code> sur un extrait de la base auto</li>
<li>On va utiliser la fonction <code>pairplot</code> de la librairie <code>seaborn</code> (acronyme <code>sns</code>)</li>
<li><code>seaborn</code> ne permettant pas au graphique de s’afficher directement aorès son exécution avec Stata, il est enregistré avec la fonction <code>nom_objet.savefig(path/nom_graph)</code> puis ouvert via le prompteur windows <code>! nom_graph</code></li>
</ul>
<pre><code>python:
import seaborn as sns
g = sns.pairplot(df, hue=&quot;foreign&quot;)
g.savefig(&quot;graph1.png&quot;)
end

! graph1.png</code></pre>
<p>Programme en un bloc</p>
<pre><code>sysuse auto, clear
keep price mpg displacement gear_ratio turn foreign
save auto, replace

python:
import pandas as pa 
import seaborn as sns
df = pa.read_stata(&#39;auto.dta&#39;)
g = sns.pairplot(df, hue=&quot;foreign&quot;)
g.savefig(&quot;graph1.png&quot;)
end
! graph1.png</code></pre>
<p><img src="img/p1.png" /></p>
</div>
<div id="exemple-2" class="section level3" number="2.3.3">
<h3 number="2.3.3"><span class="header-section-number">2.3.3</span> Exemple 2</h3>
<p>Création d’un graphique de type <em>violin</em> de la librairie <code>plotpy</code> en passant une macro à un argument de Stata vers Python</p>
<p><strong>MAJ du 04/11/20</strong>: on peut se passer de la librairie <code>SFI</code>, la démarche étant un peu lourde, et utiliser directement les macros dans la fonction <code>violin</code> de <em>Plotly</em>. Voir le programme en fin de page. C’est franchement plus simple.</p>
<p><strong>Etape par étape</strong><br />
<br></p>
<p><strong>Définition d’une variable par une macro</strong></p>
<pre><code>local x turn</code></pre>
<p>Les codes qui suivent sont appelés en mode python</p>
<pre><code>python:
&lt;py1&gt;: chargement des librairies&gt;
&lt;py2&gt;: récupération de la macro et création d&#39;une dataframe
&lt;py3&gt;: création du graphique et affichage
end</code></pre>
<p><strong>[Py1] Chargement des librairies</strong></p>
<pre><code>import pandas as pa
import plotly.graph_objects as go
from sfi import *</code></pre>
<ul>
<li>Une des particularités de python (et ce n’est pas un point fort) est qu’il est (parfois) nécessaire de charger explicitement des fonctions d’une librairie: ici la librairie est <code>plotly</code> dans laquelle on veut utiliser la fonction <code>graph_objects</code>. On importe non pas la librairie, mais une fonctionnalité de celle-ci: <code>import plotly.graph_objects as go</code></li>
<li>On importe également, dans son ensemble, la librairie python <code>SFI</code> de Stata: <code>from sfi import *</code> (* car on importe tous les modules)</li>
</ul>
<p><strong>[Py2] Récupération de la macro et création de la dataframe</strong></p>
<pre><code>varname = Macro.getLocal(&quot;x&quot;)
v = Data.get(var = varlist)
df = pd.DataFrame(v,columns = [&#39;var&#39;])</code></pre>
<ul>
<li><code>varname = Macro.getLocal("x")</code> permet a python de récupéré le contenu de la macro x</li>
</ul>
<pre><code>&gt;&gt;&gt; varname = Macro.getLocal(&quot;x&quot;)
&gt;&gt;&gt; varname
&#39;turn&#39;</code></pre>
<ul>
<li><code>v = Data.get(var = varname)</code> permet de récupérer, sous forme d’un vecteur, les observations de la variable associée à la macro (ici <em>turn</em>)</li>
</ul>
<pre><code>&gt;&gt;&gt; v = Data.get(var = varname)
&gt;&gt;&gt; v
[40, 40, 40, 43, 43, 42, 43, 42, 44, 43, 45, 34, 43, 31, 41, 40, 43, 35, 46, 46, 46, 33, 43, 5
&gt; 1, 48, 41, 39, 48, 44, 41, 45, 43, 43, 42, 42, 42, 43, 40, 43, 37, 37, 36, 44, 42, 42, 45, 4
&gt; 0, 41, 37, 36, 34, 35, 32, 34, 38, 36, 36, 34, 33, 34, 36, 36, 35, 36, 36, 35, 35, 36, 37]</code></pre>
<ul>
<li><code>df = pd.DataFrame(v,columns = ['var'])</code> transforme le vecteur en dataframe. J’ai choisi le nom <em>var</em> pour la variable, je n’ai pas (encore) trouvé le moyen d’utiliser le contenu de la macro pour la variable sélectionné. Mais c’est sans importance pour ce graphique, on pourra récupérer le nom de la variable pour le titre.</li>
</ul>
<pre><code>&gt;&gt;&gt; df = pa.DataFrame(v,columns = [&#39;var&#39;])
&gt;&gt;&gt; df.head()
   var
0   40
1   40
2   40
3   43
4   43</code></pre>
<p><strong>[Py3] Création de l’objet graphique</strong></p>
<pre><code>fig = go.Figure(data=go.Violin(y=df[&#39;var&#39;], box_visible=True, line_color=&#39;black&#39;, meanline_visible=True, 
fillcolor=&#39;rgb(248,118,109)&#39;, opacity=0.5, x0=&#39;var&#39;))
fig.update_layout( title=&quot; violin plot pour la variable `x&#39;&quot;, font=dict( family=&quot;Arial&quot;, size=18, color=&#39;rgb(97,156,255)&#39;))
python: fig.show())</code></pre>
<ul>
<li>La variable est appelée par <code>y=df['var']</code>, le reste constitue des options</li>
<li><code>fig.update_layout</code> permet d’ajouter des éléments de type texte. On peut récupérer directement le nom de la variable dans le titre avec la macro <em>x</em>: <strong>title=“violin plot pour la variable `x’”</strong>. On pourrait faire de même avec les titres des axes.<br />
</li>
<li><code>fig.show()</code> permet d’afficher le graphique sous format <em>html</em> (format des graphique de <code>plotly</code>). On peut se déplacer sur le graphique pour lire les valeurs (moyenne, médiane, valeur de y et la valeur de la densité estimée. Le graphique peut être enregistré en format statique (.png) directement via le menu de la fenêtre.</li>
</ul>
<iframe width="800" height="600" src="img/p2.html">
</iframe>
<p><strong>Programme en un bloc</strong></p>
<pre><code>local x turn

python clear
python:
import plotly.graph_objects as go
import pandas as pa
from sfi import *
varname = Macro.getLocal(&quot;x&quot;)
v = Data.get(var = varname)
df = pa.DataFrame(v,columns = [&#39;var&#39;])
df.head()

fig = go.Figure(data=go.Violin(y=df[&#39;var&#39;], box_visible=True, line_color=&#39;black&#39;, meanline_visible=True, 
fillcolor=&#39;rgb(248,118,109)&#39;, opacity=0.5, x0=&#39;var&#39;))
fig.update_layout( title=&quot; Violin plot pour la variable `x&#39;&quot;, font=dict( family=&quot;Arial&quot;, size=18, color=&#39;rgb(97,156,255)&#39;))
python: fig.show()

end</code></pre>
<p><strong>Dans une routine type ado</strong><br />
Je rencontre une difficulté pour afficher le graphique avec un programme en deux blocs, un bloc Stata puis un bloc python. Une histoire de fonction à appeler dans le bloc Stata que je n’arrive pas à définir</p>
<pre><code>programme define violin
syntax varlist [,options]
&lt;programme Stata&gt;
end

python:
&lt;code python&gt;
end</code></pre>
<p>En un bloc, en appelant Python à chaque ligne, ce qui n’est franchement pas génial, la routine suivante fonctionne</p>
<pre><code>***Programme de la commande violon***

*partie Stata
capt program drop violin
program define violin
syntax varlist, [title(string)] [ytitle(string)] [xtitle(string)]


*partie python
python: import plotly.graph_objects as go
python: import pandas as pd
python: from sfi import *

python: varlist = Macro.getLocal(&quot;varlist&quot;)
python: v = Data.get(var = varlist)
python: df = pd.DataFrame(v,columns = [&#39;var&#39;])

python: fig = go.Figure(data=go.Violin(y=df[&#39;var&#39;], box_visible=True, line_color=&#39;black&#39;, meanline_visible=True, fillcolor=&#39;lightseagreen&#39;, opacity=0.5, x0=&#39;var&#39;))
python: fig.update_layout( title=&quot;`title&#39;&quot;, xaxis_title=&quot;`xtitle&#39;&quot;, yaxis_title=&quot;`ytitle&#39;&quot;, font=dict( family=&quot;Courier New, monospace&quot;, size=18, color=&quot;#7f7f7f&quot;))
python: fig.show()

end


***Execution de la commande***
* sysuse auto, clear
* violin mpg
* violin price, title(&quot;GRAPHIQUE TYPE VIOLON&quot;) xtitle(&quot;PRICE&quot;)
</code></pre>
<p><strong>MAJ du 04 Novembre 2020</strong></p>
<ul>
<li>On va utiliser directement la macro qui enregistre le nom de la variable, ici <em>turn</em>, dans la fonction <code>violin</code></li>
<li>On utilise la fonction <code>read_stata</code> de la librairie <code>pandas</code> pour charger la base Stata</li>
<li>On voit que la macro <code>x</code> est directement utilisable dans la fonction <code>violin</code>:</li>
</ul>
<pre><code>go.Violin(y=df[&#39;`x&#39;&#39;],....)</code></pre>
<ul>
<li>Bizarrement dans le programme précédent, j’avais utilisé directement la macro `title’ dans le programme Python, sans tester la même chose pour la variable</li>
</ul>
<pre><code>sysuse auto, clear

local x turn

python: 
import plotly.graph_objects as go
import pandas as pa

df = pa.read_stata(&#39;auto.dta&#39;)

fig = go.Figure(data=go.Violin(y=df[&#39;`x&#39;&#39;], 
box_visible=True, 
line_color=&#39;black&#39;, meanline_visible=True, 
fillcolor=&#39;rgb(248,118,109)&#39;, 
opacity=0.5, x0=&#39;var&#39;))
fig.update_layout( title=&quot; Violin plot pour la variable `x&#39;&quot;, 
font=dict( family=&quot;Arial&quot;, 
size=18, color=&#39;rgb(97,156,255)&#39;))

fig.show()

end</code></pre>
</div>
</div>
</div>
<div id="visualisation-des-données-plotnine" class="section level1" number="3">
<h1 number="3"><span class="header-section-number">3</span> Visualisation des données (plotnine…)</h1>
<ul>
<li>Principe: reprendre des visualisations de la partie <a href="https://mthevenin.github.io/stata_fr/graphiques.html#5_Visualisation_des_donn%C3%A9es_avec_Stata"><em>visualisation des données avec Stata</em></a> avec des codes python exécutables dans un .do.</li>
<li><strong>Tous les chemins mènent à ggplot</strong>: J’utiliserai principalement le wrapper de ggplot2, <strong>plotnine</strong> (Hassan Kibirige).</li>
<li>Par rapport à <strong>seaborn</strong>, <strong>plotnine</strong> affiche directement les graphiques, et je n’ai pas rencontré de problème avec les axes lorsque les coordonnées sont modifiées (obligé de fermer et réouvrir le .do avec <em>seaborn</em>). Il faut néanmoins penser à fermer la fenêtre avant d’exécuter un nouveau graphique pour qu’il s’affiche.</li>
<li>On peut se reporter facilement aux ressources sur <strong>ggplot2</strong> pour construire un graphique avec <strong>plotnine</strong>, la syntaxe étant quasiment identique.</li>
<li>Support <strong>plotnine</strong> (fonctions peu détaillées): <a href="https://plotnine.readthedocs.io/en/stable/index.html" class="uri">https://plotnine.readthedocs.io/en/stable/index.html</a></li>
<li>Traduction des chapitres de l’ouvrage <em><a href="https://r4ds.had.co.nz/">R for data science</a></em> (H.Wickham,G.Grolemund) dédiés à <strong>ggplot</strong> en <strong>plotnine</strong>: <a href="https://datascienceworkshops.com/blog/plotnine-grammar-of-graphics-for-python/" class="uri">https://datascienceworkshops.com/blog/plotnine-grammar-of-graphics-for-python/</a></li>
<li>Quelques ressources ggplot2:
<ul>
<li><a href="https://larmarange.github.io/seminaire-INED-18juin2019/diaporama.html#/" class="uri">https://larmarange.github.io/seminaire-INED-18juin2019/diaporama.html#/</a> et <a href="https://larmarange.github.io/analyse-R/" class="uri">https://larmarange.github.io/analyse-R/</a> (plusieurs chapitres dédiés aux graphiques)</li>
<li><a href="http://www.sthda.com/english/wiki/be-awesome-in-ggplot2-a-practical-guide-to-be-highly-effective-r-software-and-data-visualization" class="uri">http://www.sthda.com/english/wiki/be-awesome-in-ggplot2-a-practical-guide-to-be-highly-effective-r-software-and-data-visualization</a> (en)</li>
<li>Beaucoup d’entraides via les forums type <em>stackexchange</em></li>
</ul></li>
</ul>
<p><strong>Différence plotnine / ggplot2</strong></p>
<ul>
<li>La couverture des fonctionnalités de <em>ggplot2</em> avec <em>plotnine</em> n’est pas totale, elle serait de 95% (J.Janssens).</li>
<li>On doit utiliser la parenthèse comme délimiteur si le graphique est exécuté sur plusieurs lignes</li>
<li>Les arguments de certaines options ne sont pas sépararés par <code>.</code> mais par <code>_</code> [par exemple <code>axis_text_x</code> au lieu de <code>axis.text.x</code>]</li>
</ul>
<p><strong>Installation des librairies</strong></p>
<p>Dans l’invite de commande windows</p>
<pre><code>pip install plotnine
pip install matplotlib
pip install seaborn</code></pre>
<p><strong>Un premier exemple</strong></p>
<p>Exécution dans un .do et affichage du graphique</p>
<p><img src="gpython/g0.PNG" /></p>
<ul>
<li>Les coordonnées du graphique sont renseignées dans <code>aes(....)</code>. Il s’agit du <em>mapping</em> du graphique</li>
<li><code>fill='foreign'</code> permet d’avoir des couleurs</li>
<li>Le nuage de point est exécuté avec <code>geom_point</code> avec en options:
<ul>
<li>La taille des bulles: <code>size=5</code></li>
<li>Une réduction de l’opacité de la couleur des bulles: <code>alpha=.8</code></li>
</ul></li>
</ul>
<pre><code>sysuse auto, clear

keep price mpg foreign
save auto2, replace

python: 

# penser à charger les librairies à chaque session
import pandas as pa
import plotnine as p9
from plotnine import *

# Ouverture de la base stata avec pandas
df=pa.read_stata(&#39;D:/stata_temp/auto2.dta&#39;)
df.head()

#graphique ggplot avec plotnine
(
ggplot(df, aes(x=&#39;price&#39;, y=&#39;mpg&#39;, fill=&#39;foreign&#39;))
+ geom_point(size=5, alpha=.8)

)

end</code></pre>
<p><img src="gpython/g1.png" /></p>
<div id="histogramme-et-densité" class="section level2" number="3.1">
<h2 number="3.1"><span class="header-section-number">3.1</span> Histogramme et Densité</h2>
<ul>
<li>L’histogramme est exécuté avec <strong><code>geom_histogram()</code></strong></li>
<li>La largeur des barres a été fixée à 10 par l’option <code>binwidth</code></li>
<li>La couleur des barres est entrée en hexadecimal (pour convertir du rgb en hex:<a href="http://www.proftnj.com/RGB3.htm" class="uri">http://www.proftnj.com/RGB3.htm</a>) avec l’option <code>fill</code></li>
<li>La couleur du contour des barres est entré avec l’option <code>color</code></li>
</ul>
<p><img src="gpython/g2.png" /></p>
<pre><code>import delimited &quot;https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/1_OneNum.csv&quot;, clear
keep if price&lt;=300
save price, replace

python:

df=pa.read_stata(&#39;D:/stata_temp/price.dta&#39;)
df.head()

(
    ggplot(df, aes(x=&#39;price&#39;))
    + geom_histogram(binwidth=10, alpha=0.8, fill=&#39;#41B6C4&#39;, colour=&#39;black&#39;)
)

end</code></pre>
<ul>
<li>Pour une densité, on utilise <strong><code>geom_density()</code></strong></li>
</ul>
<p><img src="gpython/g3.png" /></p>
<pre><code>python:

(
    ggplot(df, aes(x=&#39;price&#39;))
    + geom_density(alpha=0.8, fill=&#39;#41B6C4&#39;, colour=&#39;black&#39;)
)

end</code></pre>
<ul>
<li>On peut ajouter sous forme de petites barres la distribution de la variable avec <strong><code>geom_rug()</code></strong></li>
</ul>
<p><img src="gpython/g4.png" /></p>
<pre><code>python:

(
    ggplot(df, aes(x=&#39;price&#39;))
    + geom_density(alpha=0.8, fill=&#39;#41B6C4&#39;, colour=&#39;black&#39;)
    + geom_rug()
)

end</code></pre>
</div>
<div id="box-plot-et-violin" class="section level2" number="3.2">
<h2 number="3.2"><span class="header-section-number">3.2</span> Box plot et violin</h2>
<p><em>Préparation des données</em></p>
<pre><code>clear
set obs 1000

gen     A = rnormal(10,5)
gen     B = rnormal(13,1) in 1/500
replace B = rnormal(18,1) in 501/1000
gen     C = rnormal(25,5) in 1/20
gen     D = rnormal(12,2) in 1/10

stack A B C D,  into(y)

    gen x=&quot;A&quot; if _stack==1
replace x=&quot;B&quot; if _stack==2
replace x=&quot;C&quot; if _stack==3
replace x=&quot;D&quot; if _stack==4

drop _stack
drop if y==.

save &quot;box&quot;, replace</code></pre>
<p><strong>BOX PLOT</strong></p>
<ul>
<li>On trace une box plot avec <em><code>geom_boxplo()t</code></em></li>
<li>Les <em>notches</em> permettent de mieux faire apparaitre la médiane</li>
<li>On retire la légende, les valeurs des catégories étant déjà reportées sur x, avec <strong><code>theme(legend_position='none')</code></strong>. <em><code>theme(....)</code></em> permet d’entrer toutes les options générales du graphique</li>
</ul>
<p><img src="gpython/g5.png" /></p>
<pre><code>python:

df=pa.read_stata(&#39;D:/stata_temp/box.dta&#39;)
df.head()

(
    ggplot(df, aes(x=&#39;factor(x)&#39;, y=&#39;y&#39;, fill=&#39;factor(x)&#39;))
    +  geom_boxplot(notch=True)
    + theme(legend_position=&#39;none&#39;)
)

end</code></pre>
<p>Si l’on souhaite contrôler le nombre d’observations par catégorie on peut tracer des jitters avec <strong><code>geom_jitter()</code></strong></p>
<p><img src="gpython/g6.png" /></p>
<pre><code>python:
(
  ggplot(df, aes(x=&#39;factor(x)&#39;, y=&#39;y&#39;, fill=&#39;factor(x)&#39;)) 
  +  geom_jitter(size=2, color=&#39;white&#39;) 
  + theme(legend_position=&#39;none&#39;)
) 

end</code></pre>
<p>Ces jitters peuvent être facilement ajouter aux box en arrière plan.</p>
<p><img src="gpython/g7.png" /></p>
<pre><code>python:

g1= aes(x=&#39;factor(x)&#39;, y=&#39;y&#39;)
g2= aes(x=&#39;factor(x)&#39;, y=&#39;y&#39;, fill=&#39;factor(x)&#39;)
(
ggplot(df, aes(&#39;factor(x)&#39;, y=&#39;y&#39;))
 + geom_jitter(g1, size=1, width=.2, alpha=1, fill=&#39;black&#39; , color=&#39;white&#39;)
 + geom_boxplot(g2, alpha=.7, notch=True)
 + theme(legend_position=&#39;none&#39;)    
)

end</code></pre>
<p><strong>BEAN &amp; VIOLIN</strong></p>
<ul>
<li>Les graphiques de type beans réprésentent la même densité en mirroir. Ils sont néanmoins exécutés avec <strong><code>geom_violin()</code></strong></li>
<li>On ajoute la valeur des quartiles avec <strong><code>draw_quantiles=(.25,.5,.75)</code></strong></li>
<li>Pour obtenir des violins, on doit superposer une box plot, ce qu’on fait dans le second graphique.</li>
</ul>
<p><img src="gpython/g8.png" /></p>
<pre><code>python:

(
    ggplot(df, aes(x=&#39;factor(x)&#39;, y=&#39;y&#39;, fill=&#39;factor(x)&#39;))
    +  geom_violin(g2, alpha=.7, draw_quantiles=(.25,.5,.75))
    + theme(legend_position=&#39;none&#39;)
)

end</code></pre>
<p>Le graphique <em>violin</em> avec des jitters en arrière plan</p>
<p><img src="gpython/g9.png" /></p>
<pre><code>python: 

v= aes(x=&#39;factor(x)&#39;, y=&#39;y&#39;, fill=&#39;factor(x)&#39;)
(
ggplot(df, aes(&#39;factor(x)&#39;, y=&#39;y&#39;))
 + geom_jitter(size=1, width=.2, alpha=1, fill=&#39;black&#39; , color=&#39;white&#39;)
 + geom_violin(v, alpha=.7)
 + geom_boxplot(alpha=1, width=.1)
 + theme(legend_position=&#39;none&#39;)    
)

end</code></pre>
<p>Découverte un peu par hasard, peut-être que la meilleure visualisation est donnée ici par la géométrie <strong><code>geom_sina</code></strong> qui contrôle les coordonnées des jitters sur l’axe discret par la valeur de la densité.</p>
<p><img src="gpython/g9b.png" /></p>
<p>L’option <code>stroke</code> permet de changer l’épaisseur du contour des bulles</p>
<pre><code>python:
(
    ggplot(df, aes(x=&#39;factor(x)&#39;, y=&#39;y&#39;, fill=&#39;factor(x)&#39;))
    +  geom_sina(size=1, color=&#39;black&#39;, stroke=.1)
    +  geom_boxplot(alpha=.5, fill=&#39;white&#39;, width=.1)
    + theme(legend_position=&#39;none&#39;)
)
end</code></pre>
</div>
<div id="application-sur-les-probabilités-assignées" class="section level2" number="3.3">
<h2 number="3.3"><span class="header-section-number">3.3</span> Application sur les probabilités assignées</h2>
<p><br></p>
<p>Le graphique avec les 17 densités est peu lisible</p>
<p><img src="gpython/g10.png" /></p>
<p>Je me suis calé sur l’option par défaut de Stata avec l’option <code>bw='silverman'</code>, qui me semble bien plus appropriée pour faire apparaître la forte concentration des réponse autoure de 50% pour “about even”.</p>
<pre><code>import pandas as pa
df=pa.read_stata(&#39;D:/Marc/SMS/FORMATIONS/2020/graph ur9/formation/probability_long.dta&#39;)
df.head()

(
      ggplot(df, aes(x=&#39;p&#39;, color=&quot;proba&quot;, fill=&#39;proba&#39;))
    + geom_density(alpha=0.7, color=&#39;black&#39;, bw=&#39;silverman&#39;)
)
</code></pre>
<p><em>Facettes</em><br />
On peut représenter rapidement les différentes densités sous forme de facettes (graphique combiné de chaque courbe)</p>
<ul>
<li>Facette: <strong><code>facet_wrap('proba')</code></strong></li>
<li>J’ai réduit la taille des titres des sous graphiques avec <strong><code>theme(strip_text = element_text(size=5))</code></strong></li>
</ul>
<p><img src="gpython/g11.png" /></p>
<pre><code>(
    ggplot(df, aes(x=&#39;p&#39;, color=&quot;proba&quot;, fill=&#39;proba&#39;))
    + geom_density(alpha=0.5, bw=&#39;silverman&#39;)
    + facet_wrap(&#39;proba&#39;)
    + theme(strip_text = element_text(size=5))
    + theme(legend_position=&#39;none&#39;)   
)</code></pre>
<p>Même type de graphique avec des histogrammes</p>
<p><img src="gpython/g12.png" /></p>
<pre><code>(
    ggplot(df, aes(x=&#39;p&#39;, color=&quot;proba&quot;, fill=&#39;proba&#39;))
    + geom_histogram(alpha=0.5, binwidth=5)
    + facet_wrap(&#39;proba&#39;)
    + theme(strip_text = element_text(size=5))
    + theme(legend_position=&#39;none&#39;)   
)</code></pre>
<p><em>Boxplot</em><br />
<br></p>
<p>Des box-plot me semblent assez appropriées, avec ici des effectifs identiques pour tous les groupes.</p>
<p><img src="gpython/g14.png" /></p>
<p><em>Ridge</em><br />
<br> La librairie plotnine n’a pas une fonction comme <code>ggridge</code> pour tracer des courbes de ridge.<br />
On peut utiliser la librarie <strong><code>joypy</code></strong>, dont la syntaxe est simple, mais provoque (chez moi) un crash de Stata</p>
</div>
<div id="nuages-et-densités-2d" class="section level2" number="3.4">
<h2 number="3.4"><span class="header-section-number">3.4</span> Nuages et densités 2D</h2>
<ul>
<li>Pour les nuages de points on utilise <strong><code>geom_point()</code></strong></li>
<li>Pour les densités (courbes de niveau) et les histogrammes sur deux axes de coordonnées on utilise <strong><code>geom_density_2d</code></strong> et <strong><code>geom_bin2d</code></strong></li>
<li>On tracera également le graphique combiné avec les distributions marginales à l’aide de la fonction <strong><code>jointplot</code></strong> de la librairies <strong><code>seaborn</code></strong></li>
</ul>
<p><em>Préparation de données</em></p>
<pre><code>use &quot;D:/Marc/SMS/FORMATIONS/2020/graph ur9/formation/twonums.dta&quot;, clear

keep if surface&lt;=3000
keep if prix&lt;=500000

save &quot;prix_surface&quot;, replace

python: 

import pandas as pa
import plotnine as p9
from plotnine import *
import numpy as np
df=pa.read_stata(&#39;D:/stata_temp/prix_surface.dta&#39;)
df.head()

end</code></pre>
<p><strong>Nuages de points</strong><br />
<br></p>
<p><img src="gpython/g15.png" /></p>
<pre class="{"><code>python:

(
ggplot(df, aes(x=&#39;surface&#39;, y=&#39;prix&#39;)) 
+ geom_point(color=&#39;#41B6C4&#39;)    
)

end</code></pre>
<p>On réduit la taille des bulles avec l’option “<code>size</code>”</p>
<p><img src="gpython/g16.png" /></p>
<pre><code>python:

(
ggplot(df, aes(x=&#39;surface&#39;, y=&#39;prix&#39;))
+ geom_point(color=&#39;#41B6C4&#39;, size=.1)    
)

end</code></pre>
<p><strong>Courbes de niveau</strong><br />
<br></p>
<p><img src="gpython/g17.png" /></p>
<p>L’option <strong><code>level</code></strong> donne comme avec Stata le nombre de courbes de niveau qui sont estimées</p>
<pre><code>python:

(
ggplot(df, aes(x=&#39;surface&#39;, y=&#39;prix&#39;))   
+ geom_density_2d(color=&#39;#41B6C4&#39;, levels=20, size=.5)   
)

end</code></pre>
<p>On peut empiler le nuage de points les courbes (+ petites barres sur les axes pour les distributions marginales)</p>
<p><img src="gpython/g18.png" /></p>
<pre><code>python:

(
ggplot(df, aes(x=&#39;surface&#39;, y=&#39;prix&#39;))
+ geom_point(size=.1, color=&#39;#41B6C4&#39;)   
+ geom_density_2d(levels=20,  size=.5)   
+ geom_rug(color=&#39;#41B6C4&#39;)
)

end</code></pre>
<p>Pour reporter des couleurs pour chaque ligne de niveau ou remplir d’une couleur différente la surface entre chaque courbe, ça se complique un peu. Je ne serai pas vraiment capable d’expliquer le pourquoi du comment de la syntaxe de l’argument <strong><code>'..level..'</code></strong></p>
<p><img src="gpython/g19.png" /></p>
<pre><code>python:

(
ggplot(aes(x=&#39;surface&#39;, y=&#39;prix&#39;, color=&#39;..level..&#39;)) 
+ geom_density_2d(levels=20, size=.5)
+ theme(legend_position=&#39;none&#39;)   
)

end</code></pre>
<p><img src="gpython/g20.png" /></p>
<pre><code>python:
(
ggplot(aes(x=&#39;surface&#39;, y=&#39;prix&#39;)) 
+  stat_density_2d(aes(fill=&#39;..level..&#39;), geom = &quot;polygon&quot;,  contour=True, levels=20)
+ geom_density_2d(levels=20, size=.5, color=&#39;black&#39;)  
+ theme(legend_position=&#39;none&#39;)        
)
end

</code></pre>
<p><strong>Heatmap (histogramme 2d)</strong><br />
<br></p>
<p>Il n’y a pas (encore) de version sous forme d’hexagone</p>
<p><img src="gpython/g21.png" /></p>
<pre><code>python:
(
ggplot(aes(x=&#39;surface&#39;, y=&#39;prix&#39;))
+ geom_bin2d(bins = 50, color=&#39;white&#39;, size=.2)    
)
end</code></pre>
<p><strong>Combinaison avec les distributions marginales (seaborn)</strong></p>
<ul>
<li>La fonction <strong><code>jointplot</code></strong> semble ici la plus adaptée, syntaxe très simple</li>
<li>L’option <strong><code>kind</code></strong> définira le type de représentation: nuage/histogramme, heatmap/histogramme, courbe de niveau/densités [par défaut nuage + histogramme]</li>
</ul>
<pre><code>import seaborn as sns
import matplotlib as plt</code></pre>
<p><img src="gpython/g22.png" /></p>
<pre><code>python:

g = sns.jointplot(data=df, y=&quot;prix&quot;, x=&quot;surface&quot;, color=&#39;#41B6C4&#39;)
g.savefig(&quot;graph1.png&quot;)
end

!graph1.png</code></pre>
<p><img src="gpython/g23.png" /></p>
<pre><code>python:

g = sns.jointplot(data=df, y=&quot;prix&quot;, x=&quot;surface&quot;, color=&#39;#41B6C4&#39;, kind=&#39;hist&#39;)
g.savefig(&quot;graph1.png&quot;)
end

!graph1.png</code></pre>
<p>On peut obtenire une heatmap avec des hexagones avec l’option <code>kind='hex'</code></p>
<p><img src="gpython/g24.png" /></p>
<pre><code>python:

g = sns.jointplot(data=df, y=&quot;prix&quot;, x=&quot;surface&quot;, color=&#39;#41B6C4&#39;, kind=&#39;hex&#39;)
g.savefig(&quot;graph1.png&quot;)
end

!graph1.png</code></pre>
<p><img src="gpython/g25.png" /></p>
<pre><code>python:

g = sns.jointplot(data=df, y=&quot;prix&quot;, x=&quot;surface&quot;, color=&#39;#41B6C4&#39;, kind=&#39;kde&#39;)
g.savefig(&quot;graph1.png&quot;)
end

!graph1.png</code></pre>
<p>L’option <code>fill</code> permet de remplir l’aire entre les courbes de niveau ainsi que les densités marginales</p>
<p><img src="gpython/g26.png" /></p>
<pre><code>python:

g = sns.jointplot(data=df, y=&quot;prix&quot;, x=&quot;surface&quot;, color=&#39;#41B6C4&#39;, kind=&#39;kde&#39;, fill=&#39;#41B6C4&#39;)
g.savefig(&quot;graph1.png&quot;)
end

!graph1.png</code></pre>
</div>
<div id="courbes" class="section level2" number="3.5">
<h2 number="3.5"><span class="header-section-number">3.5</span> Courbes</h2>
<ul>
<li>Applications sur les prénoms (effet spaghetti)</li>
<li>Pour tracer des courbes on utilise <strong><code>geom_line()</code></strong></li>
<li>Si on veut remplir la surface sous la courbe par une couleur on utilise <strong><code>geom_area()</code></strong>. C’est le même principe qu’avec les graphiques Stata.</li>
</ul>
<p><em>Préparation des données (Stata)</em></p>
<pre><code>clear
import delimited using &quot;https://raw.githubusercontent.com/mthevenin/stata_fr/master/babynames.csv&quot;
gen mary=&quot;Mary&quot; if name==&quot;Mary&quot;
save babyname, replace</code></pre>
<p>Le graphique peu lisible si les courbes sont empilées sur un même graphique</p>
<p><img src="gpython/g27.png" /></p>
<pre><code>python:
(
ggplot(df, aes(x=&#39;year&#39;, y=&#39;n&#39;, group=&#39;name&#39;, color=&#39;name&#39;)) 
+ geom_line()  
)
end</code></pre>
<p>Comme pour les densités, on peut représenter les courbes sous formes de facettes. J’ai ajouter quelques options pour contrôler la taille des textes et ajouter un titre au graphique. Une version avec le remplissage de l’aire sous les courbes est également donnée: on replace <code>color='name'</code> par <code>'fill='name'</code> et <code>geom_line()</code> par <code>geom_area</code>.</p>
<p><img src="gpython/g28.png" /></p>
<pre><code>python:
(
    ggplot(df, aes(x=&#39;year&#39;, y=&#39;n&#39;, group=&#39;name&#39;, color=&#39;name&#39;))
    + geom_line()  
    + facet_wrap(&#39;name&#39;)
    + theme(strip_text = element_text(size=5),
            axis_text_x = element_text(size = 5),
            axis_text_y = element_text(size = 6),
            legend_position=&#39;none&#39;) 
    + labs(title=&quot;Popularity of american names&quot;)
)
end</code></pre>
<p><img src="gpython/g28b.png" /></p>
<pre><code>python:
(
    ggplot(df, aes(x=&#39;year&#39;, y=&#39;n&#39;, group=&#39;name&#39;, fill=&#39;name&#39;))
    + geom_line()  
    + facet_wrap(&#39;name&#39;)
    + theme(strip_text = element_text(size=5),
            axis_text_x = element_text(size = 5),
            axis_text_y = element_text(size = 6),
            legend_position=&#39;none&#39;) 
    + labs(title=&quot;Popularity of american names&quot;)
)
end</code></pre>
<p>L’autre solution est de mettre un nom en <em>highlight</em>. On superpose la courbe pour Mary (verte et plus épaisse) aux autres (grises, plus fines).<br />
La version pour tous les prénoms sous forme de facettes, particulièrement lourde à programmer avec Stata n’est pas tracée, je n’ai pas trouvé de solution simple avec <em>plotnine</em> (le graphique d’origine de Yan Holtz, sous R, mobilise des fonctions <code>dplyr</code>dans les arguments <code>ggplot</code>).</p>
<p><img src="gpython/g29.png" /></p>
<pre><code>python:
mary = df.query(&quot;name == &#39;Mary&#39;&quot;)

(
    ggplot(df, aes(x=&#39;year&#39;, y=&#39;n&#39;, group=&#39;name&#39;))
  + geom_line(color=&#39;grey&#39;)  
    + geom_line(mary, aes(x=&#39;year&#39;, y=&#39;n&#39;), color=&quot;#2DB27D&quot;, size=1.5)
    + labs(title=&quot;Popularity of Mary&quot;, color=&quot;#2DB27D&quot;)
    + theme(
    plot_title = element_text(colour = &quot;#2DB27D&quot;)
    )
)
end</code></pre>
</div>
<div id="barres-et-lollipop" class="section level2" number="3.6">
<h2 number="3.6"><span class="header-section-number">3.6</span> Barres et lollipop</h2>
<p>Cela va se compliquer un peu (ordre des barres, légende pour les comparaisons)<br />
<br></p>
<ul>
<li>On exécute des graphiques de types barres avec <strong><code>geom_bar</code></strong>.</li>
<li>Pour un graphique de type <strong>lollipop</strong>, on utilise <strong><code>geom_segment()</code></strong> et <strong><code>geom_point()</code></strong></li>
<li>Pour ordonner les barres, on utilisera la fonction <code>reorder()</code>. Cela alourdit la syntaxe du graphique, mais évite d’utiliser des fonctions <code>pandas</code> elles mêmes assez lourdes.</li>
<li>Comme il s’agit d’utiliser Python avec Stata, les données seront mises en forme avec la commande <code>collapse</code>.</li>
</ul>
<p><strong>Barres</strong></p>
<p>*Préparation des données (Stata)</p>
<pre><code>sysuse nlsw88.dta, clear
keep wage occupation union
drop if inlist(occupation,9,10,12, .) 
save nlsw88.dta, replace


keep wage occupation union
drop if inlist(occupation,9,10,12, .) 

preserve

collapse wage, by(occ)
drop if occ==.
drop if wage==.

save wage1, replace

restore</code></pre>
<ul>
<li>On réutilisera <code>geom_bar()</code> pour les variables catégorielles, mais ici comme on a une observation par branche professionnelle, aucun calcul n’est nécessaire pour générer le graphique. On indique que les valeurs sont prises telles quelles avec l’option <strong><code>stat=identity</code></strong>.</li>
<li>Comme les graphiques de type barres sont plus lisibles horizontalement, on inverse les coordonnées avec <code>coord_flip()</code></li>
</ul>
<p><img src="gpython/g30.png" /></p>
<pre><code>(
ggplot()
+ geom_bar(df,aes(x=&#39;occupation&#39;, y=&#39;wage&#39;) , stat=&#39;identity&#39;, color=&#39;black&#39;, fill=&#39;#225EA8&#39;)
+ ylab(&quot;Wage (mean)&quot;)
+ xlab(&quot;Occupation&quot;)    
+ coord_flip()
)</code></pre>
<p>Pour trier les branches selon la valeur du salaire moyen horaire, on utilise dans le mapping la fonction <strong><code>reorder(variable,valeur)</code></strong>. L’argument <em>valeur</em> est donné par la variable <em>wage</em></p>
<p><img src="gpython/g31.png" /></p>
<pre><code>python:
(
ggplot()
+ geom_bar(df,aes(x=&#39;reorder(occupation,wage)&#39;, y=&#39;wage&#39;) , stat=&#39;identity&#39;, color=&#39;black&#39;, fill=&#39;#225EA8&#39;)
+ ylab(&quot;Wage (mean)&quot;)
+ xlab(&quot;Occupation&quot;)    
+ coord_flip()
)
end</code></pre>
<p>Pour inverser l’ordre on remplace dans la fonction <code>reorder()</code> <em>wage</em> par <em>-wage</em></p>
<p><img src="gpython/g31b.png" /></p>
<pre><code>python:
(
ggplot()
+ geom_bar(df,aes(x=&#39;reorder(occupation,-wage)&#39;, y=&#39;wage&#39;) , stat=&#39;identity&#39;, color=&#39;black&#39;, fill=&#39;#225EA8&#39;)
+ ylab(&quot;Wage (mean)&quot;)
+ xlab(&quot;Occupation&quot;)    
+ coord_flip()
)
end</code></pre>
<p><strong>Lollipop</strong></p>
<ul>
<li>Sur le même principe que Stata, on utilise <strong><code>geom_segment()</code></strong> [stata: <code>pci</code>] et <strong><code>point_point()</code></strong> [stata: <code>scatter</code>] pour afficher ce type de graphique</li>
<li>Une version avec écarts par rapport au salaire moyen toutes branches professionnelles confondues est présentées. En amont on récupère cette moyenne avec Stata et on génère les différences (variable <em>diffw</em>) dans la base collapsée.</li>
</ul>
<p><em>Préparation des données</em><br />
<br></p>
<pre><code>use nlsw88,clear

qui sum wage
local mw = `r(mean)&#39;

preserve

collapse wage, by(occupation)
drop if occ==.
drop if wage==.
gen mw = `mw&#39;
gen diffw = wage - mw
save wage1, replace

restore

python:
df=pa.read_stata(&#39;D:/stata_temp/wage1.dta&#39;)
df.head()
end</code></pre>
<p><img src="gpython/g32.png" /></p>
<pre><code>python:
(
ggplot()
+ geom_segment(df,aes(y=&#39;occupation&#39;,  yend=&#39;occupation&#39;, x=0, xend=&#39;wage&#39;), size=1.2, color=&#39;#225EA8&#39;)
+ geom_point(df, aes(y=&#39;occupation&#39;, x=&#39;wage&#39;), size=3.5, color=&#39;#225EA8&#39;, fill=&#39;#1D91C0&#39;)  
+ xlab(&quot;Wage (mean)&quot;)
)
end</code></pre>
<p><img src="gpython/g33.png" /></p>
<pre><code>python:
(
ggplot()
+ geom_segment(df,aes(y=&#39;reorder(occupation,wage)&#39;, yend=&#39;reorder(occupation,wage)&#39;, 
                      x=0, xend=&#39;wage&#39;), size=1.2, color=&#39;#225EA8&#39;)
+ geom_point(df, aes(y=&#39;reorder(occupation,wage)&#39;,   x=&#39;wage&#39;), size=3.5, fill=&#39;#1D91C0&#39; )  
+ xlab(&quot;Wage (mean)&quot;)
+ ylab(&quot;Occupation&quot;)    
)
end</code></pre>
<p>On peut jouer sur l’épaisseur des segments et la couleur des bulles</p>
<p><img src="gpython/g33b.png" /></p>
<pre><code>python:
(
ggplot()
+ geom_segment(df,aes(y=&#39;reorder(occupation,wage)&#39;, yend=&#39;reorder(occupation,wage)&#39;, 
                      x=0, xend=&#39;wage&#39;), size=5.8, color=&#39;#225EA8&#39;)
+ geom_point(df, aes(y=&#39;reorder(occupation,wage)&#39;,   x=&#39;wage&#39;), size=5, fill=&#39;yellow&#39; )  
+ xlab(&quot;Wage (mean)&quot;)
+ ylab(&quot;Occupation&quot;)    
)
end</code></pre>
<p>Pour visualiser les différences entre le salaire moyen des branches et la moyenne sur l’ensemble des observations on utilise la variable <em>diffw</em> au lieu de <em>wage</em></p>
<p><img src="gpython/g34.png" /></p>
<pre><code>python:
(
ggplot()
+ geom_segment(df,aes(y=&#39;reorder(occupation,diffw)&#39;, yend=&#39;reorder(occupation,diffw)&#39;, x=0, xend=&#39;diffw&#39;), size=1.2, color=&#39;#225EA8&#39;)
+ geom_point(df, aes(y=&#39;reorder(occupation,diffw)&#39;,   x=&#39;diffw&#39;), size=3.5, fill=&#39;#1D91C0&#39; )  
+ xlab(&quot;Ecarts avec le salaire moyen&quot;)
+ ylab(&quot;Professions&quot;)    
)
end</code></pre>
<ul>
<li>Pour améliorer le graphique on peut ajouter une barre verticale sur x=0<br />
</li>
<li>On a également changer le thème du graphique: <strong><code>theme_light()</code></strong></li>
</ul>
<p><img src="gpython/g35.png" /></p>
<pre><code>(
ggplot()
+ geom_segment(df,aes(y=&#39;reorder(occupation,diffw)&#39;, yend=&#39;reorder(occupation,diffw)&#39;, x=0, xend=&#39;diffw&#39;), size=1.2, color=&#39;#225EA8&#39;)
+ geom_point(df, aes(y=&#39;reorder(occupation,diffw)&#39;,   x=&#39;diffw&#39;), size=3.5, fill=&#39;#1D91C0&#39; )
+ geom_segment(df,aes(y=1, yend=10, x=0, xend=0), size=1.2, color=&#39;#225EA8&#39;)  
+ xlab(&quot;wage - mean(wage)&quot;)
+ ylab(&quot;Occupation&quot;)    
+ theme_light()
)</code></pre>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
